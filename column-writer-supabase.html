<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Column Writer â€” AIã‚³ãƒ©ãƒ åŸ·ç­†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Noto+Serif+JP:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Noto Sans JP', 'Hiragino Sans', sans-serif; background: #faf8f5; color: #3d3225; min-height: 100vh; }
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea, select { font-family: inherit; outline: none; }
input:focus, textarea:focus { border-color: #c8b89a !important; }
button:active { transform: scale(0.98); }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: #d0c8b8; border-radius: 3px; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

/* â”€â”€â”€ Loading â”€â”€â”€ */
.loading-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
.loading-spinner { width: 32px; height: 32px; border: 3px solid #e8e4de; border-top-color: #8b7355; border-radius: 50%; animation: spin 0.8s linear infinite; }
.loading-text { color: #8a8a8a; margin-top: 16px; font-family: 'Noto Serif JP', serif; }

/* â”€â”€â”€ Setup Screen â”€â”€â”€ */
.setup-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #faf8f5 0%, #f0ede8 50%, #e8e2d8 100%); }
.setup-card { background: #fff; border-radius: 16px; padding: 48px 40px; width: 520px; max-width: 92vw; box-shadow: 0 4px 24px rgba(0,0,0,0.06); }
.setup-title { font-size: 20px; font-weight: 700; color: #2d2518; font-family: 'Noto Serif JP', serif; margin-bottom: 6px; }
.setup-desc { font-size: 13px; color: #8a8070; margin-bottom: 24px; line-height: 1.6; }
.setup-label { font-size: 13px; font-weight: 600; color: #3d3225; margin-bottom: 6px; display: block; }
.setup-input { width: 100%; padding: 10px 14px; border: 1px solid #e0dcd6; border-radius: 8px; font-size: 14px; margin-bottom: 16px; transition: border-color 0.2s; }
.setup-input.mono { font-family: 'SF Mono', Consolas, monospace; font-size: 12px; }
.setup-submit { width: 100%; padding: 12px; background: #3d3225; color: #fff; border-radius: 10px; font-size: 14px; font-weight: 600; margin-top: 8px; }
.setup-submit:disabled { opacity: 0.45; cursor: not-allowed; }
.setup-error { margin-top: 12px; padding: 10px 14px; background: #fef2f2; color: #b91c1c; border-radius: 8px; font-size: 13px; }
.setup-success { margin-top: 12px; padding: 10px 14px; background: #ecfdf5; color: #065f46; border-radius: 8px; font-size: 13px; }

/* â”€â”€â”€ Login â”€â”€â”€ */
.login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #faf8f5 0%, #f0ede8 50%, #e8e2d8 100%); }
.login-card { background: #fff; border-radius: 16px; padding: 48px 40px; width: 420px; max-width: 90vw; box-shadow: 0 4px 24px rgba(0,0,0,0.06); }
.login-header { text-align: center; margin-bottom: 36px; }
.logo-mark { width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, #3d3225 0%, #6b5a42 100%); color: #f0e8d8; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; font-family: 'Noto Serif JP', serif; margin-bottom: 16px; }
.login-title { font-size: 22px; font-weight: 700; color: #2d2518; font-family: 'Noto Serif JP', serif; margin-bottom: 4px; }
.login-subtitle { font-size: 13px; color: #8a8070; }
.login-label { font-size: 12px; color: #8a8070; margin-bottom: 10px; font-weight: 600; letter-spacing: 0.05em; }
.user-btn { display: flex; align-items: center; width: 100%; padding: 12px 16px; background: transparent; border: 1px solid #e8e4de; border-radius: 10px; font-size: 14px; color: #3d3225; margin-bottom: 8px; transition: background 0.15s; }
.user-btn:hover { background: #f0ede8; }
.user-btn svg { margin-right: 10px; flex-shrink: 0; }
.new-account-btn { color: #8b7355; font-size: 13px; padding: 8px 0; font-weight: 500; }
.login-row { display: flex; gap: 8px; }
.login-input { flex: 1; padding: 10px 14px; border: 1px solid #e0dcd6; border-radius: 8px; font-size: 14px; }
.login-submit { padding: 10px 24px; background: #3d3225; color: #fff; border-radius: 8px; font-size: 14px; font-weight: 600; }
.back-btn-small { color: #8b7355; font-size: 13px; margin-top: 8px; }

/* â”€â”€â”€ App Layout â”€â”€â”€ */
.app-container { display: flex; min-height: 100vh; }
.sidebar { width: 240px; background: #2d2518; color: #d4c8b0; display: flex; flex-direction: column; justify-content: space-between; position: fixed; top: 0; left: 0; bottom: 0; z-index: 10; padding: 20px 0; }
.sidebar-logo { display: flex; align-items: center; padding: 0 20px; margin-bottom: 28px; }
.logo-mark-sm { width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, #6b5a42 0%, #8b7355 100%); color: #f0e8d8; display: flex; align-items: center; justify-content: center; font-size: 16px; font-family: 'Noto Serif JP', serif; }
.sidebar-title { margin-left: 10px; font-size: 15px; font-weight: 700; color: #f0e8d8; font-family: 'Noto Serif JP', serif; }
.nav-section { display: flex; flex-direction: column; gap: 2px; padding: 0 8px; }
.nav-item { display: flex; align-items: center; padding: 10px 12px; border-radius: 8px; color: #bfb49e; font-size: 13px; text-align: left; width: 100%; transition: all 0.15s; }
.nav-item:hover { background: rgba(255,255,255,0.06); }
.nav-item.active { background: rgba(255,255,255,0.1); color: #f0e8d8; }
.nav-item svg { margin-right: 10px; flex-shrink: 0; }
.nav-badge { margin-left: auto; background: #c8956a; color: #fff; font-size: 10px; font-weight: 700; border-radius: 10px; padding: 2px 7px; }
.sidebar-footer { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.08); }
.user-info { display: flex; align-items: center; color: #bfb49e; font-size: 13px; }
.user-info svg { margin-right: 8px; }
.logout-btn { color: #8a7a64; padding: 6px; border-radius: 6px; }
.logout-btn:hover { color: #f0e8d8; }

/* â”€â”€â”€ Main â”€â”€â”€ */
.main-content { margin-left: 240px; flex: 1; min-height: 100vh; }
.view-container { padding: 36px 48px; max-width: 860px; margin: 0 auto; animation: fadeIn 0.3s ease; }
.view-title { font-size: 22px; font-weight: 700; color: #2d2518; margin-bottom: 6px; font-family: 'Noto Serif JP', serif; }
.view-desc { font-size: 13px; color: #8a8070; margin-bottom: 28px; }

/* â”€â”€â”€ Write â”€â”€â”€ */
.write-card { background: #fff; border-radius: 14px; padding: 28px; border: 1px solid #e8e4de; }
.info-bar { display: flex; gap: 20px; margin-bottom: 20px; font-size: 13px; color: #8a8070; padding: 10px 16px; background: #faf8f5; border-radius: 8px; flex-wrap: wrap; }
.info-bar strong { color: #5a4832; }
.field-label { display: block; font-size: 14px; font-weight: 600; color: #3d3225; margin-bottom: 6px; }
.field-hint { font-size: 12px; color: #a09888; margin-bottom: 12px; line-height: 1.6; }
.prompt-textarea { width: 100%; padding: 16px; border: 1px solid #e0dcd6; border-radius: 10px; font-size: 14px; line-height: 1.8; resize: vertical; background: #fdfcfa; transition: border-color 0.2s; }
.prompt-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 14px; }
.char-indicator { font-size: 12px; color: #a09888; }
.generate-btn { display: flex; align-items: center; gap: 6px; padding: 11px 28px; background: linear-gradient(135deg, #3d3225, #5a4832); color: #fff; border-radius: 10px; font-size: 14px; font-weight: 600; transition: all 0.2s; }
.generate-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.generate-btn:not(:disabled):hover { box-shadow: 0 4px 12px rgba(61,50,37,0.3); }
.mini-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite; }
.error-msg { margin-top: 12px; padding: 10px 14px; background: #fef2f2; color: #b91c1c; border-radius: 8px; font-size: 13px; }

/* â”€â”€â”€ Result â”€â”€â”€ */
.result-card { background: #fff; border-radius: 14px; padding: 28px; border: 1px solid #e8e4de; }
.result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
.result-title { font-size: 16px; font-weight: 700; color: #2d2518; font-family: 'Noto Serif JP', serif; margin-bottom: 4px; }
.char-badge { font-size: 12px; color: #6b5a42; background: #f5f0e8; padding: 3px 10px; border-radius: 12px; font-weight: 600; }
.header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.icon-btn { background: none; border: 1px solid #e0dcd6; border-radius: 8px; padding: 6px 8px; color: #6b5a42; display: flex; align-items: center; }
.icon-btn:hover { background: #f5f0e8; }
.sm-btn { display: flex; align-items: center; gap: 4px; border: 1px solid #e0dcd6; border-radius: 8px; padding: 6px 12px; font-size: 12px; color: #6b5a42; }
.sm-btn:hover { background: #f5f0e8; }
.sm-btn.active { background: #f5f0e8; border-color: #c8b89a; }
.title-input { width: 100%; padding: 10px 14px; border: 1px solid #e0dcd6; border-radius: 8px; font-size: 16px; font-weight: 700; font-family: 'Noto Serif JP', serif; margin-bottom: 10px; }
.edit-textarea { width: 100%; padding: 16px; border: 1px solid #e0dcd6; border-radius: 10px; font-size: 14px; line-height: 2; resize: vertical; background: #fdfcfa; }
.preview-area { padding: 20px 24px; background: #fdfcfa; border-radius: 10px; border: 1px solid #f0ede8; margin-top: 8px; max-height: 500px; overflow-y: auto; }
.preview-title { font-size: 18px; font-weight: 700; color: #2d2518; margin-bottom: 20px; font-family: 'Noto Serif JP', serif; }
.preview-p { font-size: 14px; line-height: 2; color: #3d3225; margin-bottom: 16px; white-space: pre-wrap; }
.revision-area { margin-top: 20px; padding: 16px 20px; background: #faf8f5; border-radius: 10px; }
.revision-row { display: flex; gap: 8px; margin-top: 8px; }
.revision-input { flex: 1; padding: 9px 14px; border: 1px solid #e0dcd6; border-radius: 8px; font-size: 13px; }
.revise-btn { display: flex; align-items: center; gap: 5px; padding: 9px 16px; background: #6b5a42; color: #fff; border-radius: 8px; font-size: 13px; font-weight: 600; white-space: nowrap; }
.revise-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.save-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; flex-wrap: wrap; }
.save-draft-btn { padding: 10px 22px; background: #f5f0e8; color: #5a4832; border: 1px solid #d8d0c0; border-radius: 10px; font-size: 13px; font-weight: 600; }
.save-draft-btn:hover { background: #ebe5d8; }
.save-complete-btn { display: flex; align-items: center; gap: 6px; padding: 10px 24px; background: linear-gradient(135deg, #3d6b35, #4a8040); color: #fff; border-radius: 10px; font-size: 13px; font-weight: 600; }
.save-complete-btn:hover { box-shadow: 0 4px 12px rgba(61,107,53,0.3); }
.cancel-btn { padding: 10px 22px; background: #f5f0e8; color: #8a8070; border-radius: 8px; font-size: 13px; }
.back-link { display: flex; align-items: center; gap: 4px; color: #8b7355; font-size: 13px; padding: 8px 0; margin-top: 12px; }
.back-link:hover { color: #5a4832; }

/* â”€â”€â”€ Archive â”€â”€â”€ */
.filter-bar { display: flex; gap: 6px; margin-bottom: 20px; }
.filter-btn { display: flex; align-items: center; gap: 5px; padding: 6px 14px; background: #f5f0e8; border: 1px solid transparent; border-radius: 8px; font-size: 12px; color: #6b5a42; font-weight: 500; }
.filter-btn:hover { background: #ebe5d8; }
.filter-btn.active { background: #3d3225; color: #f0e8d8; }
.filter-count { font-size: 10px; background: rgba(0,0,0,0.08); border-radius: 8px; padding: 1px 6px; }
.column-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 14px; }
.column-card { background: #fff; border-radius: 12px; padding: 18px 20px; border: 1px solid #e8e4de; cursor: pointer; transition: all 0.2s; }
.column-card:hover { border-color: #c8b89a; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.status-tag { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 6px; }
.status-complete { background: #ecfdf5; color: #065f46; }
.status-draft { background: #fef9e7; color: #92400e; }
.card-title { font-size: 15px; font-weight: 700; color: #2d2518; margin-bottom: 6px; font-family: 'Noto Serif JP', serif; line-height: 1.4; }
.card-excerpt { font-size: 12px; color: #8a8070; line-height: 1.6; margin-bottom: 10px; }
.card-footer { display: flex; justify-content: space-between; align-items: center; }
.card-chars { font-size: 12px; color: #999; }
.delete-btn { color: #c4a882; padding: 4px; border-radius: 4px; display: flex; }
.delete-btn:hover { color: #b91c1c; }
.complete-sm-btn { display: flex; align-items: center; gap: 4px; background: #3d6b35; border-radius: 8px; padding: 6px 14px; font-size: 12px; color: #fff; font-weight: 600; }
.empty-state { text-align: center; padding: 48px 20px; color: #8a8070; font-size: 14px; }
.empty-hint { font-size: 13px; color: #aaa; margin-top: 6px; }

/* â”€â”€â”€ Past Columns â”€â”€â”€ */
.upload-area { display: flex; align-items: center; gap: 12px; padding: 20px 24px; background: #fff; border-radius: 12px; border: 1px dashed #d0c8b8; flex-wrap: wrap; margin-bottom: 16px; }
.upload-btn { display: flex; align-items: center; gap: 6px; padding: 10px 20px; background: #3d3225; color: #f0e8d8; border-radius: 10px; font-size: 13px; font-weight: 600; }
.upload-btn:hover { background: #5a4832; }
.upload-hint { font-size: 12px; color: #999; }
.upload-divider { margin: 0 8px; color: #ccc; }
.manual-btn { padding: 10px 20px; background: #f5f0e8; color: #5a4832; border: 1px solid #d8d0c0; border-radius: 10px; font-size: 13px; font-weight: 500; }
.manual-btn:hover { background: #ebe5d8; }
.manual-area { margin-bottom: 16px; padding: 20px; background: #fff; border-radius: 12px; border: 1px solid #e8e4de; }
.section-title { font-size: 14px; font-weight: 600; color: #5a4832; margin-bottom: 12px; letter-spacing: 0.03em; }
.past-list { display: flex; flex-direction: column; gap: 8px; }
.past-card { display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: #fff; border-radius: 10px; border: 1px solid #e8e4de; }
.past-card-info { flex: 1; min-width: 0; }
.past-card-title { font-size: 14px; font-weight: 600; color: #2d2518; margin-bottom: 4px; }
.past-card-excerpt { font-size: 12px; color: #8a8070; margin-bottom: 4px; line-height: 1.5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.past-card-meta { font-size: 11px; color: #aaa; }

/* â”€â”€â”€ Rules â”€â”€â”€ */
.rule-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f0ede8; font-size: 14px; line-height: 1.6; }
.rule-dot { color: #c8956a; font-size: 8px; margin-top: 6px; flex-shrink: 0; }
.rule-dot-custom { color: #8b7355; }
.rule-text { flex: 1; }
.rule-add-row { display: flex; gap: 8px; margin-top: 16px; }
.rule-input { flex: 1; padding: 10px 14px; border: 1px solid #e0dcd6; border-radius: 8px; font-size: 13px; }
.add-rule-btn { padding: 10px 22px; background: #3d3225; color: #f0e8d8; border-radius: 8px; font-size: 13px; font-weight: 600; }
.add-rule-btn:disabled { opacity: 0.45; cursor: not-allowed; }

/* â”€â”€â”€ Settings â”€â”€â”€ */
.settings-card { background: #fff; border-radius: 14px; padding: 24px 28px; border: 1px solid #e8e4de; margin-bottom: 20px; }
.settings-hint { font-size: 12px; color: #a09888; margin-bottom: 10px; line-height: 1.6; }
.api-key-row { display: flex; gap: 8px; }
.api-key-input { flex: 1; padding: 10px 14px; border: 1px solid #e0dcd6; border-radius: 8px; font-size: 12px; font-family: 'SF Mono', Consolas, monospace; }
.api-save-btn { padding: 10px 20px; background: #3d6b35; color: #fff; border-radius: 8px; font-size: 13px; font-weight: 600; }
.api-status { font-size: 12px; margin-top: 8px; }
.api-status.ok { color: #065f46; }
.api-status.empty { color: #92400e; }

/* â”€â”€â”€ Responsive â”€â”€â”€ */
@media (max-width: 768px) {
  .sidebar { width: 56px; padding: 12px 0; }
  .sidebar-logo { padding: 0 12px; justify-content: center; }
  .sidebar-title, .nav-item span, .user-info span, .nav-badge { display: none; }
  .nav-item { justify-content: center; padding: 10px; }
  .nav-item svg { margin-right: 0; }
  .sidebar-footer { flex-direction: column; gap: 8px; padding: 8px; }
  .main-content { margin-left: 56px; }
  .view-container { padding: 20px 16px; }
  .column-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="app">
  <div class="loading-screen">
    <div class="loading-spinner"></div>
    <p class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  â˜… Supabaseè¨­å®š â€” ã“ã“ã«ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å…¥åŠ›  â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SUPABASE_URL = '';   // ä¾‹: 'https://xxxxxxxxxxxx.supabase.co'
const SUPABASE_ANON_KEY = ''; // ä¾‹: 'eyJhbGciOiJIUzI1NiIs...'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DEFAULT_RULES = [
  { id: 'r1', text: '1,500ã€œ3,000å­—ç¨‹åº¦' },
  { id: 'r2', text: 'å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ–‡å­—æ•°ã¯ãŠãŠã‚ˆãå‡ç­‰ã«ã™ã‚‹ï¼ˆä¾‹ï¼š500å­—Ã—4ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰' },
];

// â”€â”€â”€ Helpers â”€â”€â”€
const cc = t => (t||'').replace(/\s/g,'').length;
const fmt = d => { const x=new Date(d); return `${x.getFullYear()}/${String(x.getMonth()+1).padStart(2,'0')}/${String(x.getDate()).padStart(2,'0')}`; };
const esc = s => { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; };
const $ = s => document.querySelector(s);

// â”€â”€â”€ SVG Icons â”€â”€â”€
const icons = {
  pen: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>`,
  file: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>`,
  settings: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>`,
  archive: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>`,
  sparkle: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3l1.9 5.5L19.5 10l-5.6 1.5L12 17l-1.9-5.5L4.5 10l5.6-1.5Z"/></svg>`,
  user: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
  upload: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>`,
  trash: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`,
  check: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
  chevLeft: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>`,
  edit: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
  refresh: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>`,
  copy: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`,
  logout: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`,
  key: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>`,
};

// â”€â”€â”€ State â”€â”€â”€
let db = null;
let state = { currentUser: null, view: 'write', viewingColumn: null, editMode: false, users: [], pastColumns: [], columns: [], customRules: [] };
let writeState = { prompt:'', result:null, editMode:false, editTitle:'', editContent:'', feedback:'', generating:false, revising:false, error:'' };
let archiveFilter = 'all';
let showManual = false;

// â”€â”€â”€ Supabase Init â”€â”€â”€
function initSupabase() {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return null;
  return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}

// â”€â”€â”€ DB Operations â”€â”€â”€
async function dbLoadUsers() {
  const { data } = await db.from('users').select('*').order('name');
  return data || [];
}

async function dbCreateUser(name) {
  const { data, error } = await db.from('users').insert({ name }).select().single();
  if (error) { if (error.code === '23505') { const { data: existing } = await db.from('users').select('*').eq('name', name).single(); return existing; } throw error; }
  return data;
}

async function dbLoadPastColumns(userId) {
  const { data } = await db.from('past_columns').select('*').eq('user_id', userId).order('uploaded_at', { ascending: false });
  return data || [];
}

async function dbAddPastColumn(userId, title, content) {
  const { data } = await db.from('past_columns').insert({ user_id: userId, title, content, char_count: cc(content) }).select().single();
  return data;
}

async function dbDeletePastColumn(id) {
  await db.from('past_columns').delete().eq('id', id);
}

async function dbLoadColumns(userId) {
  const { data } = await db.from('columns').select('*').eq('user_id', userId).order('updated_at', { ascending: false });
  return data || [];
}

async function dbAddColumn(userId, col) {
  const { data } = await db.from('columns').insert({ user_id: userId, title: col.title, content: col.content, char_count: col.charCount, status: col.status, original_prompt: col.originalPrompt }).select().single();
  return data;
}

async function dbUpdateColumn(id, updates) {
  const { data } = await db.from('columns').update(updates).eq('id', id).select().single();
  return data;
}

async function dbDeleteColumn(id) {
  await db.from('columns').delete().eq('id', id);
}

async function dbLoadCustomRules(userId) {
  const { data } = await db.from('custom_rules').select('*').eq('user_id', userId).order('created_at');
  return data || [];
}

async function dbAddCustomRule(userId, text) {
  const { data } = await db.from('custom_rules').insert({ user_id: userId, text }).select().single();
  return data;
}

async function dbDeleteCustomRule(id) {
  await db.from('custom_rules').delete().eq('id', id);
}

// â”€â”€â”€ Load user data â”€â”€â”€
async function loadUserData() {
  if (!state.currentUser) return;
  const uid = state.currentUser.id;
  state.pastColumns = await dbLoadPastColumns(uid);
  state.columns = await dbLoadColumns(uid);
  state.customRules = await dbLoadCustomRules(uid);
}

// â”€â”€â”€ AI Generation â”€â”€â”€
async function generateColumnAI(prompt, pastCols, rules, draft, feedback) {
  const apiKey = localStorage.getItem('mavis-anthropic-key') || '';
  if (!apiKey) throw new Error('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€ŒAPIè¨­å®šã€ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚');

  const rulesText = [...DEFAULT_RULES, ...rules].map(r => `ãƒ»${r.text}`).join('\n');
  const pastSamples = (pastCols||[]).slice(0,5).map((c,i) => `ã€éå»ã‚³ãƒ©ãƒ ${i+1}ã€‘\nã‚¿ã‚¤ãƒˆãƒ«: ${c.title}\n${c.content}`).join('\n\n---\n\n');

  const systemPrompt = `ã‚ãªãŸã¯ã€éå»ã®ã‚³ãƒ©ãƒ ã®æ–‡ä½“ãƒ»è«–èª¿ãƒ»æ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œç’§ã«æ¨¡å€£ã™ã‚‹ã‚´ãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã—ã¦ã‚³ãƒ©ãƒ ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ï¼š

ã€åŸ·ç­†ãƒ«ãƒ¼ãƒ«ã€‘
${rulesText}

ã€é‡è¦ãªåˆ¶ç´„ã€‘
- å¿…ãš1,500ã€œ3,000å­—ï¼ˆç©ºç™½é™¤ãï¼‰ã§æ›¸ãã“ã¨
- ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ•°ã¯3ã€œ5ã¤ã§ã€å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ–‡å­—æ•°ã‚’ãŠãŠã‚ˆãå‡ç­‰ã«ã™ã‚‹ã“ã¨
- éå»ã‚³ãƒ©ãƒ ã®æ–‡ä½“ãƒ»å£èª¿ãƒ»è¡¨ç¾ã®ç™–ã‚’å¾¹åº•çš„ã«çœŸä¼¼ã‚‹ã“ã¨
- ãã®ã¾ã¾å…¬é–‹ã§ãã‚‹å“è³ªã«ä»•ä¸Šã’ã‚‹ã“ã¨
- ã‚¿ã‚¤ãƒˆãƒ«ã‚‚ä»˜ã‘ã‚‹ã“ã¨

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
TITLE: ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰
---
ï¼ˆæœ¬æ–‡ï¼šã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã¯ç©ºè¡Œ2ã¤ã§åŒºåˆ‡ã‚‹ï¼‰`;

  let userMsg = '';
  if (draft && feedback) {
    userMsg = `ä»¥ä¸‹ã®ã‚³ãƒ©ãƒ è‰ç¨¿ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n\nã€ä¿®æ­£æŒ‡ç¤ºã€‘\n${feedback}\n\nã€ç¾åœ¨ã®è‰ç¨¿ã€‘\n${draft}${pastSamples?'\n\nã€å‚è€ƒï¼šéå»ã®ã‚³ãƒ©ãƒ ï¼ˆæ–‡ä½“å‚è€ƒç”¨ï¼‰ã€‘\n'+pastSamples:''}`;
  } else {
    userMsg = `ä»¥ä¸‹ã®å†…å®¹ãƒ»ãƒ¡ãƒ¢ã‚’ã‚‚ã¨ã«ã‚³ãƒ©ãƒ ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚\n\nã€æ›¸ããŸã„å†…å®¹ãƒ»ãƒ¡ãƒ¢ã€‘\n${prompt}${pastSamples?'\n\nã€å‚è€ƒï¼šéå»ã®ã‚³ãƒ©ãƒ ï¼ˆæ–‡ä½“å‚è€ƒç”¨ï¼‰ã€‘\n'+pastSamples:''}`;
  }

  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 4096, system: systemPrompt, messages: [{ role: 'user', content: userMsg }] }),
  });

  if (!resp.ok) { const err = await resp.json().catch(()=>({})); throw new Error(err.error?.message || `APIã‚¨ãƒ©ãƒ¼ (${resp.status})`); }
  const data = await resp.json();
  const text = (data.content||[]).map(b=>b.text||'').join('');
  const titleMatch = text.match(/TITLE:\s*(.+)/);
  const title = titleMatch ? titleMatch[1].trim() : 'ç„¡é¡Œã®ã‚³ãƒ©ãƒ ';
  const body = text.replace(/TITLE:\s*.+\n-{2,}\n?/, '').trim();
  return { title, content: body, charCount: cc(body) };
}

// â”€â”€â”€ Render â”€â”€â”€
function render() {
  if (!db) { renderSetup(); return; }
  if (!state.currentUser) { renderLogin(); return; }
  renderApp();
}

// â”€â”€â”€ Setup Screen (no Supabase config) â”€â”€â”€
function renderSetup() {
  const app = $('#app');
  app.innerHTML = `
    <div class="setup-container">
      <div class="setup-card">
        <div style="text-align:center;margin-bottom:28px">
          <div class="logo-mark">ç­†</div>
          <h1 class="setup-title">Column Writer åˆæœŸè¨­å®š</h1>
          <p class="setup-desc">Supabaseã®æ¥ç¶šæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>æ¥ç¶šæƒ…å ±ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã® Settings â†’ API ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚</p>
        </div>
        <label class="setup-label">Supabase Project URL</label>
        <input class="setup-input mono" id="setup-url" placeholder="https://xxxxxxxxxxxx.supabase.co" value="${localStorage.getItem('sb-url')||''}">
        <label class="setup-label">Supabase anon key</label>
        <input class="setup-input mono" id="setup-key" placeholder="eyJhbGciOiJIUzI1NiIs..." value="${localStorage.getItem('sb-key')||''}">
        <button class="setup-submit" onclick="doSetup()" id="setup-btn">æ¥ç¶šãƒ†ã‚¹ãƒˆ &amp; ä¿å­˜</button>
        <div id="setup-msg"></div>
      </div>
    </div>`;
}

window.doSetup = async function() {
  const url = ($('#setup-url')?.value||'').trim();
  const key = ($('#setup-key')?.value||'').trim();
  if (!url || !key) { $('#setup-msg').innerHTML = '<div class="setup-error">ä¸¡æ–¹ã®å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>'; return; }
  $('#setup-btn').disabled = true;
  $('#setup-btn').textContent = 'æ¥ç¶šä¸­...';
  try {
    const testDb = supabase.createClient(url, key);
    const { error } = await testDb.from('users').select('id').limit(1);
    if (error) throw error;
    localStorage.setItem('sb-url', url);
    localStorage.setItem('sb-key', key);
    db = testDb;
    $('#setup-msg').innerHTML = '<div class="setup-success">âœ“ æ¥ç¶šæˆåŠŸï¼ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™...</div>';
    setTimeout(() => { state.users = []; render(); }, 1000);
  } catch(e) {
    $('#setup-msg').innerHTML = `<div class="setup-error">æ¥ç¶šå¤±æ•—: ${esc(e.message)}<br>URLãƒ»Keyãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆsetup.sqlå®Ÿè¡Œï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>`;
    $('#setup-btn').disabled = false;
    $('#setup-btn').textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆ & ä¿å­˜';
  }
};

// â”€â”€â”€ Login â”€â”€â”€
async function renderLogin() {
  try { state.users = await dbLoadUsers(); } catch(e) { state.users = []; }
  const users = state.users;
  const app = $('#app');
  app.innerHTML = `
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <div class="logo-mark">ç­†</div>
          <h1 class="login-title">Column Writer</h1>
          <p class="login-subtitle">AIã‚³ãƒ©ãƒ åŸ·ç­†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</p>
        </div>
        <div id="login-body">
          ${users.length ? `
            <div id="user-list">
              <p class="login-label">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠ</p>
              ${users.map(u => `<button class="user-btn" onclick="loginAs('${u.id}')">${icons.user}<span>${esc(u.name)}</span></button>`).join('')}
              <button class="new-account-btn" onclick="$('#user-list').style.display='none';$('#create-form').style.display='';$('#login-name').focus()">ï¼‹ æ–°ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</button>
            </div>
          ` : ''}
          <div id="create-form" style="${users.length?'display:none':''}">
            <p class="login-label">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <div class="login-row">
              <input class="login-input" id="login-name" placeholder="ä¾‹ï¼šç”°ä¸­å¤ªéƒ" onkeydown="if(event.key==='Enter')doCreateUser()">
              <button class="login-submit" onclick="doCreateUser()">é–‹å§‹</button>
            </div>
            ${users.length?`<button class="back-btn-small" onclick="$('#user-list').style.display='';$('#create-form').style.display='none'">â† æˆ»ã‚‹</button>`:''}
            <div id="login-error"></div>
          </div>
        </div>
      </div>
    </div>`;
}

window.loginAs = async function(userId) {
  const u = state.users.find(x=>x.id===userId);
  if (!u) return;
  state.currentUser = u;
  localStorage.setItem('mavis-user-id', u.id);
  await loadUserData();
  render();
};

window.doCreateUser = async function() {
  const name = ($('#login-name')?.value||'').trim();
  if (!name) return;
  try {
    const u = await dbCreateUser(name);
    state.currentUser = u;
    localStorage.setItem('mavis-user-id', u.id);
    await loadUserData();
    render();
  } catch(e) {
    $('#login-error').innerHTML = `<div class="error-msg" style="margin-top:8px">${esc(e.message)}</div>`;
  }
};

// â”€â”€â”€ App Shell â”€â”€â”€
function renderApp() {
  const draftCount = state.columns.filter(c=>c.status==='draft').length;
  const navItems = [
    { id:'write', icon:icons.pen, label:'ã‚³ãƒ©ãƒ åŸ·ç­†' },
    { id:'archive', icon:icons.archive, label:'ä½œæˆæ¸ˆã¿ã‚³ãƒ©ãƒ ', badge:draftCount||'' },
    { id:'past', icon:icons.file, label:'éå»ã‚³ãƒ©ãƒ ç®¡ç†' },
    { id:'rules', icon:icons.settings, label:'åŸ·ç­†ãƒ«ãƒ¼ãƒ«' },
    { id:'apiconfig', icon:icons.key, label:'APIè¨­å®š' },
  ];
  const app = $('#app');
  app.innerHTML = `
    <div class="app-container">
      <nav class="sidebar">
        <div>
          <div class="sidebar-logo"><div class="logo-mark-sm">ç­†</div><span class="sidebar-title">Column Writer</span></div>
          <div class="nav-section">
            ${navItems.map(n=>`<button class="nav-item ${state.view===n.id?'active':''}" onclick="switchView('${n.id}')">${n.icon}<span>${n.label}</span>${n.badge?`<span class="nav-badge">${n.badge}</span>`:''}</button>`).join('')}
          </div>
        </div>
        <div class="sidebar-footer">
          <div class="user-info">${icons.user}<span>${esc(state.currentUser.name)}</span></div>
          <button class="logout-btn" onclick="doLogout()" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">${icons.logout}</button>
        </div>
      </nav>
      <main class="main-content"><div id="vc" class="view-container"></div></main>
    </div>`;
  renderView();
}

window.switchView = function(v) { state.view=v; state.viewingColumn=null; state.editMode=false; renderView(); };
window.doLogout = function() { state.currentUser=null; localStorage.removeItem('mavis-user-id'); state.view='write'; render(); };

function renderView() {
  const el = $('#vc');
  if (!el) return;
  switch(state.view) {
    case 'write': renderWrite(el); break;
    case 'archive': state.viewingColumn ? renderDetail(el) : renderArchive(el); break;
    case 'past': renderPast(el); break;
    case 'rules': renderRules(el); break;
    case 'apiconfig': renderApiConfig(el); break;
  }
}

// â”€â”€â”€ Write View â”€â”€â”€
function renderWrite(el) {
  if (!writeState.result) {
    const apiKey = localStorage.getItem('mavis-anthropic-key')||'';
    el.innerHTML = `
      <h2 class="view-title">ã‚³ãƒ©ãƒ åŸ·ç­†</h2>
      <p class="view-desc">æ›¸ããŸã„å†…å®¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã‚ãªãŸã®æ–‡ä½“ã§ã‚³ãƒ©ãƒ ã‚’ç”Ÿæˆã—ã¾ã™</p>
      <div class="write-card">
        <div class="info-bar">
          <span>ğŸ“š éå»ã‚³ãƒ©ãƒ ï¼š<strong>${state.pastColumns.length}</strong>ä»¶</span>
          <span>ğŸ“ ãƒ«ãƒ¼ãƒ«ï¼š<strong>${DEFAULT_RULES.length + state.customRules.length}</strong>ä»¶</span>
          <span>ğŸ”‘ APIï¼š<strong>${apiKey?'è¨­å®šæ¸ˆã¿':'æœªè¨­å®š'}</strong></span>
        </div>
        <label class="field-label">ã©ã†ã„ã£ãŸå†…å®¹ã®ã‚³ãƒ©ãƒ ã‚’æ›¸ããŸã„ã§ã™ã‹ï¼Ÿ</label>
        <p class="field-hint">ç®‡æ¡æ›¸ãã®ãƒ¡ãƒ¢ã€è©±ã®æµã‚Œã€ç››ã‚Šè¾¼ã¿ãŸã„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãªã©ã€æ€ã„ã¤ãã¾ã¾ã«æ›¸ã„ã¦ãã ã•ã„ã€‚</p>
        <textarea class="prompt-textarea" id="prompt-input" rows="14" placeholder="ä¾‹ï¼š&#10;ãƒ»æ–°å¹´æ˜ã‘ã¾ã—ã¦ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™&#10;ãƒ»ã€Œ2026å¹´ã®å¤§äºˆæƒ³ã€ã¿ãŸã„ãªè¨˜äº‹ãŒå‡ºã¦ã„ã‚‹&#10;ãƒ»ABCäºˆæƒ³ã®è©±ã‚’ã—ãŸã„...&#10;ãƒ»ã‚³ãƒ³ã‚µãƒ«ã®ä»•äº‹ã¨ã®ç¹‹ãŒã‚Š">${esc(writeState.prompt)}</textarea>
        <div class="prompt-footer">
          <span class="char-indicator" id="wcc">${writeState.prompt?cc(writeState.prompt)+'å­—':''}  </span>
          <button class="generate-btn" id="gen-btn" onclick="doGenerate()" ${writeState.generating||!writeState.prompt.trim()?'disabled':''}>${writeState.generating?`<span class="mini-spinner"></span> ç”Ÿæˆä¸­...`:`${icons.sparkle} ã‚³ãƒ©ãƒ ã‚’ç”Ÿæˆ`}</button>
        </div>
        ${writeState.error?`<div class="error-msg">${esc(writeState.error)}</div>`:''}
      </div>`;
    const ta=$('#prompt-input');
    ta.addEventListener('input',()=>{ writeState.prompt=ta.value; $('#wcc').textContent=ta.value?cc(ta.value)+'å­—':''; $('#gen-btn').disabled=writeState.generating||!ta.value.trim(); });
  } else {
    const count=cc(writeState.editContent), inR=count>=1500&&count<=3000;
    el.innerHTML = `
      <h2 class="view-title">ã‚³ãƒ©ãƒ åŸ·ç­†</h2><p class="view-desc">ç”Ÿæˆçµæœã‚’ç¢ºèªãƒ»ç·¨é›†ã—ã¦ãã ã•ã„</p>
      <div class="result-card">
        <div class="result-header"><div><div class="result-title">ç”Ÿæˆçµæœ</div><span class="char-badge">${count}å­— ${inR?'âœ“':'âš ï¸ ç¯„å›²å¤–'}</span></div>
          <div class="header-actions"><button class="icon-btn" onclick="doCopyW()" id="cpw">${icons.copy}</button><button class="sm-btn ${writeState.editMode?'active':''}" onclick="writeState.editMode=!writeState.editMode;renderView()">${icons.edit} ${writeState.editMode?'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼':'ç›´æ¥ç·¨é›†'}</button></div>
        </div>
        ${writeState.editMode?`<input class="title-input" id="wet" value="${esc(writeState.editTitle)}"><textarea class="edit-textarea" id="wec" rows="20">${esc(writeState.editContent)}</textarea>`:`<div class="preview-area"><h3 class="preview-title">${esc(writeState.editTitle)}</h3>${writeState.editContent.split(/\n\n+/).map(p=>`<p class="preview-p">${esc(p)}</p>`).join('')}</div>`}
        <div class="revision-area"><label class="field-label">AIã«ä¿®æ­£ã‚’æŒ‡ç¤ºã™ã‚‹</label><div class="revision-row"><input class="revision-input" id="wfb" placeholder="ä¾‹ï¼šã‚‚ã†å°‘ã—ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã«ã€æœ€å¾Œã‚’çŸ­ã" value="${esc(writeState.feedback)}" onkeydown="if(event.key==='Enter')doRevise()"><button class="revise-btn" onclick="doRevise()" ${writeState.revising||!writeState.feedback.trim()?'disabled':''}>${writeState.revising?'<span class="mini-spinner"></span>':icons.refresh} å†ç”Ÿæˆ</button></div></div>
        ${writeState.error?`<div class="error-msg">${esc(writeState.error)}</div>`:''}
        <div class="save-actions"><button class="save-draft-btn" onclick="doSaveCol('draft')">ä¸‹æ›¸ãä¿å­˜</button><button class="save-complete-btn" onclick="doSaveCol('complete')">${icons.check} å®Œæˆã¨ã—ã¦ä¿å­˜</button></div>
        <button class="back-link" onclick="resetWrite()">${icons.chevLeft} æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
      </div>`;
    if(writeState.editMode){const t=$('#wet'),c=$('#wec');if(t)t.oninput=()=>{writeState.editTitle=t.value};if(c)c.oninput=()=>{writeState.editContent=c.value};}
    const fb=$('#wfb');if(fb)fb.oninput=()=>{writeState.feedback=fb.value};
  }
}

window.doGenerate = async function() {
  writeState.generating=true; writeState.error=''; renderView();
  try { const r=await generateColumnAI(writeState.prompt,state.pastColumns,state.customRules); writeState.result=r; writeState.editTitle=r.title; writeState.editContent=r.content; }
  catch(e){ writeState.error=e.message; }
  writeState.generating=false; renderView();
};
window.doRevise = async function() {
  if(!writeState.feedback.trim())return;
  writeState.revising=true;writeState.error='';renderView();
  try{const r=await generateColumnAI(writeState.prompt,state.pastColumns,state.customRules,writeState.editContent,writeState.feedback);writeState.result=r;writeState.editTitle=r.title;writeState.editContent=r.content;writeState.feedback='';}
  catch(e){writeState.error=e.message;}
  writeState.revising=false;renderView();
};
window.doCopyW = function(){navigator.clipboard.writeText(writeState.editTitle+'\n\n'+writeState.editContent);const b=$('#cpw');if(b){b.innerHTML=icons.check;setTimeout(()=>{b.innerHTML=icons.copy},2000);}};
window.resetWrite = function(){writeState={prompt:'',result:null,editMode:false,editTitle:'',editContent:'',feedback:'',generating:false,revising:false,error:''};renderView();};

window.doSaveCol = async function(status) {
  try {
    await dbAddColumn(state.currentUser.id, { title:writeState.editTitle, content:writeState.editContent, charCount:cc(writeState.editContent), status, originalPrompt:writeState.prompt });
    state.columns = await dbLoadColumns(state.currentUser.id);
    writeState={prompt:'',result:null,editMode:false,editTitle:'',editContent:'',feedback:'',generating:false,revising:false,error:''};
    state.view='archive'; renderApp();
  } catch(e) { writeState.error=e.message; renderView(); }
};

// â”€â”€â”€ Archive â”€â”€â”€
function renderArchive(el) {
  const cols=state.columns;
  const filtered=archiveFilter==='all'?cols:cols.filter(c=>c.status===archiveFilter);
  el.innerHTML = `
    <h2 class="view-title">ä½œæˆæ¸ˆã¿ã‚³ãƒ©ãƒ </h2>
    <div class="filter-bar">${['all','complete','draft'].map(f=>{const l=f==='all'?'ã™ã¹ã¦':f==='complete'?'å®Œæˆ':'ä¸‹æ›¸ã';const n=f==='all'?cols.length:cols.filter(c=>c.status===f).length;return`<button class="filter-btn ${archiveFilter===f?'active':''}" onclick="archiveFilter='${f}';renderView()">${l}<span class="filter-count">${n}</span></button>`;}).join('')}</div>
    ${filtered.length===0?`<div class="empty-state"><p>ã¾ã ã‚³ãƒ©ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p><p class="empty-hint">ã€Œã‚³ãƒ©ãƒ åŸ·ç­†ã€ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„</p></div>`:`
    <div class="column-grid">${filtered.map(c=>`
      <div class="column-card" onclick="viewCol('${c.id}')">
        <div class="card-header"><span class="status-tag ${c.status==='complete'?'status-complete':'status-draft'}">${c.status==='complete'?'å®Œæˆ':'ä¸‹æ›¸ã'}</span><span style="font-size:12px;color:#999">${fmt(c.updated_at)}</span></div>
        <div class="card-title">${esc(c.title)}</div><p class="card-excerpt">${esc(c.content.slice(0,120))}...</p>
        <div class="card-footer"><span class="card-chars">${c.char_count}å­—</span><button class="delete-btn" onclick="event.stopPropagation();delCol('${c.id}')">${icons.trash}</button></div>
      </div>`).join('')}</div>`}`;
}

window.viewCol = function(id){state.viewingColumn=state.columns.find(c=>c.id===id);state.editMode=false;renderView();};
window.delCol = async function(id){await dbDeleteColumn(id);state.columns=state.columns.filter(c=>c.id!==id);if(state.viewingColumn?.id===id)state.viewingColumn=null;renderView();};

// â”€â”€â”€ Detail â”€â”€â”€
let detEdit={title:'',content:''};
function renderDetail(el) {
  const c=state.viewingColumn; if(!c){renderArchive(el);return;}
  el.innerHTML = `
    <button class="back-link" onclick="state.viewingColumn=null;state.editMode=false;renderView()">${icons.chevLeft} ä¸€è¦§ã«æˆ»ã‚‹</button>
    <div class="result-header" style="margin-top:16px"><div><span class="status-tag ${c.status==='complete'?'status-complete':'status-draft'}">${c.status==='complete'?'å®Œæˆ':'ä¸‹æ›¸ã'}</span><span class="char-badge" style="margin-left:8px">${c.char_count}å­—</span><span style="font-size:12px;color:#999;margin-left:8px">${fmt(c.updated_at)}</span></div>
      <div class="header-actions"><button class="icon-btn" onclick="copyCol()" id="cpc">${icons.copy}</button><button class="sm-btn ${state.editMode?'active':''}" onclick="togDetEdit()">${icons.edit} ${state.editMode?'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼':'ç·¨é›†'}</button>${c.status==='draft'?`<button class="complete-sm-btn" onclick="complCol('${c.id}')">${icons.check} å®Œæˆã«ã™ã‚‹</button>`:''}</div></div>
    ${state.editMode?`<div style="margin-top:16px"><input class="title-input" id="dt" value="${esc(detEdit.title||c.title)}"><textarea class="edit-textarea" id="dc" rows="20">${esc(detEdit.content||c.content)}</textarea><div style="display:flex;gap:8px;margin-top:12px"><button class="save-draft-btn" onclick="saveDet('${c.id}')">ä¿å­˜</button><button class="cancel-btn" onclick="state.editMode=false;renderView()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>`:`<div class="preview-area" style="margin-top:16px"><h3 class="preview-title">${esc(c.title)}</h3>${c.content.split(/\n\n+/).map(p=>`<p class="preview-p">${esc(p)}</p>`).join('')}</div>`}`;
  if(state.editMode){const t=$('#dt'),c2=$('#dc');if(t)t.oninput=()=>{detEdit.title=t.value};if(c2)c2.oninput=()=>{detEdit.content=c2.value};}
}
window.togDetEdit=function(){if(!state.editMode){detEdit={title:state.viewingColumn.title,content:state.viewingColumn.content};}state.editMode=!state.editMode;renderView();};
window.saveDet=async function(id){await dbUpdateColumn(id,{title:detEdit.title,content:detEdit.content,char_count:cc(detEdit.content)});state.columns=await dbLoadColumns(state.currentUser.id);state.viewingColumn=state.columns.find(c=>c.id===id);state.editMode=false;renderView();};
window.complCol=async function(id){await dbUpdateColumn(id,{status:'complete'});state.columns=await dbLoadColumns(state.currentUser.id);state.viewingColumn=state.columns.find(c=>c.id===id);renderView();};
window.copyCol=function(){const c=state.viewingColumn;navigator.clipboard.writeText(c.title+'\n\n'+c.content);const b=$('#cpc');if(b){b.innerHTML=icons.check;setTimeout(()=>{b.innerHTML=icons.copy},2000);}};

// â”€â”€â”€ Past Columns â”€â”€â”€
function renderPast(el) {
  const past=state.pastColumns;
  el.innerHTML = `
    <h2 class="view-title">éå»ã‚³ãƒ©ãƒ ç®¡ç†</h2><p class="view-desc">éå»ã®ã‚³ãƒ©ãƒ ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€AIãŒã‚ãªãŸã®æ–‡ä½“ã‚’å­¦ç¿’ã—ã¾ã™</p>
    <div class="upload-area"><input type="file" id="fi" accept=".txt,.md,.docx" multiple style="display:none" onchange="handleFU(this)"><button class="upload-btn" onclick="$('#fi').click()">${icons.upload} ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button><span class="upload-hint">.txt .md .docx</span><span class="upload-divider">or</span><button class="manual-btn" onclick="showManual=!showManual;renderView()">ãƒ†ã‚­ã‚¹ãƒˆã§ç›´æ¥å…¥åŠ›</button></div>
    ${showManual?`<div class="manual-area"><input class="title-input" id="mt" placeholder="ã‚³ãƒ©ãƒ ã‚¿ã‚¤ãƒˆãƒ«"><textarea class="edit-textarea" id="mc" placeholder="éå»ã®ã‚³ãƒ©ãƒ æœ¬æ–‡ã‚’è²¼ã‚Šä»˜ã‘" rows="10"></textarea><div style="display:flex;gap:8px;margin-top:12px"><button class="save-draft-btn" onclick="addManual()">è¿½åŠ </button><button class="cancel-btn" onclick="showManual=false;renderView()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>`:''}
    <div style="margin-top:24px"><h3 class="section-title">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ï¼ˆ${past.length}ä»¶ï¼‰</h3>
    ${past.length===0?`<div class="empty-state"><p>ã¾ã éå»ã‚³ãƒ©ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`:`<div class="past-list">${past.map(c=>`<div class="past-card"><div class="past-card-info"><div class="past-card-title">${esc(c.title)}</div><p class="past-card-excerpt">${esc(c.content.slice(0,100))}...</p><span class="past-card-meta">${c.char_count}å­— ãƒ» ${fmt(c.uploaded_at)}</span></div><button class="delete-btn" onclick="delPast('${c.id}')">${icons.trash}</button></div>`).join('')}</div>`}</div>`;
}

window.handleFU = async function(input) {
  const files=input.files; if(!files?.length)return;
  for(const file of files){
    try{
      let text='';
      if(file.name.endsWith('.docx')){
        const raw=new TextDecoder('utf-8',{fatal:false}).decode(await file.arrayBuffer());
        const parts=[];const re=/<w:t[^>]*>([^<]*)<\/w:t>/g;let m;
        while((m=re.exec(raw))!==null)parts.push(m[1]);
        text=parts.length?parts.join(''):raw.replace(/<[^>]+>/g,'').trim();
      } else { text=await file.text(); }
      if(text.trim()){
        await dbAddPastColumn(state.currentUser.id, file.name.replace(/\.[^/.]+$/,''), text.trim());
      }
    }catch(e){console.error(e);}
  }
  state.pastColumns=await dbLoadPastColumns(state.currentUser.id);
  input.value='';renderView();
};

window.addManual=async function(){
  const t=($('#mt')?.value||'').trim(),c=($('#mc')?.value||'').trim();if(!c)return;
  await dbAddPastColumn(state.currentUser.id,t||'ç„¡é¡Œ',c);
  state.pastColumns=await dbLoadPastColumns(state.currentUser.id);
  showManual=false;renderView();
};

window.delPast=async function(id){await dbDeletePastColumn(id);state.pastColumns=state.pastColumns.filter(c=>c.id!==id);renderView();};

// â”€â”€â”€ Rules â”€â”€â”€
function renderRules(el) {
  const custom=state.customRules;
  el.innerHTML = `
    <h2 class="view-title">åŸ·ç­†ãƒ«ãƒ¼ãƒ«</h2><p class="view-desc">ã‚³ãƒ©ãƒ ç”Ÿæˆæ™‚ã«AIãŒå‚ç…§ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã§ã™</p>
    <div style="margin-bottom:32px"><h3 class="section-title">åŸºæœ¬ãƒ«ãƒ¼ãƒ«ï¼ˆå›ºå®šï¼‰</h3>${DEFAULT_RULES.map(r=>`<div class="rule-item"><span class="rule-dot">â—</span><span>${esc(r.text)}</span></div>`).join('')}</div>
    <div><h3 class="section-title">ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«</h3>${custom.length===0?`<p style="font-size:13px;color:#aaa;margin-bottom:16px">ãªã—</p>`:''}
    ${custom.map(r=>`<div class="rule-item"><span class="rule-dot rule-dot-custom">â—†</span><span class="rule-text">${esc(r.text)}</span><button class="delete-btn" onclick="delRule('${r.id}')">${icons.trash}</button></div>`).join('')}
    <div class="rule-add-row"><input class="rule-input" id="nr" placeholder="ä¾‹ï¼šå†’é ­ã§èª­è€…ã«å•ã„ã‹ã‘ã‚‹å½¢ã§å§‹ã‚ã‚‹" onkeydown="if(event.key==='Enter')addRule()"><button class="add-rule-btn" onclick="addRule()">è¿½åŠ </button></div></div>`;
}

window.addRule=async function(){const v=($('#nr')?.value||'').trim();if(!v)return;await dbAddCustomRule(state.currentUser.id,v);state.customRules=await dbLoadCustomRules(state.currentUser.id);renderView();};
window.delRule=async function(id){await dbDeleteCustomRule(id);state.customRules=state.customRules.filter(r=>r.id!==id);renderView();};

// â”€â”€â”€ API Config â”€â”€â”€
function renderApiConfig(el) {
  const k=localStorage.getItem('mavis-anthropic-key')||'';
  el.innerHTML = `
    <h2 class="view-title">APIè¨­å®š</h2><p class="view-desc">AIç”Ÿæˆã«ä½¿ç”¨ã™ã‚‹Anthropic APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¾ã™</p>
    <div class="settings-card"><label class="field-label">Anthropic APIã‚­ãƒ¼</label><p class="settings-hint">console.anthropic.com ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</p>
      <div class="api-key-row"><input class="api-key-input" id="ak" type="password" placeholder="sk-ant-..." value="${k}"><button class="api-save-btn" onclick="saveAK()">ä¿å­˜</button></div>
      <div class="api-status ${k?'ok':'empty'}">${k?'âœ“ è¨­å®šæ¸ˆã¿':'âš  æœªè¨­å®š'}</div>
    </div>
    <div class="settings-card"><label class="field-label">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</label><p class="settings-hint">Claude Sonnet 4ï¼ˆclaude-sonnet-4-20250514ï¼‰</p></div>
    <div class="settings-card"><label class="field-label">Supabaseæ¥ç¶š</label><p class="settings-hint">URL: ${localStorage.getItem('sb-url')||'æœªè¨­å®š'}</p>
      <button class="back-link" onclick="localStorage.removeItem('sb-url');localStorage.removeItem('sb-key');db=null;render()">Supabaseæ¥ç¶šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>`;
}
window.saveAK=function(){const k=($('#ak')?.value||'').trim();localStorage.setItem('mavis-anthropic-key',k);renderView();renderApp();};

// â”€â”€â”€ Init â”€â”€â”€
(async function init() {
  const url = SUPABASE_URL || localStorage.getItem('sb-url');
  const key = SUPABASE_ANON_KEY || localStorage.getItem('sb-key');
  if (url && key) {
    try {
      db = supabase.createClient(url, key);
      // Auto-login from saved session
      const savedId = localStorage.getItem('mavis-user-id');
      if (savedId) {
        const { data } = await db.from('users').select('*').eq('id', savedId).single();
        if (data) { state.currentUser = data; await loadUserData(); }
      }
    } catch(e) { console.error(e); db = null; }
  }
  render();
})();
</script>
</body>
</html>
